<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Autark</title>
  <style>
    html {
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 12px;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      html {
        background-color: white;
      }
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    svg {
      height: auto;
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
      font-size: 85%;
      margin: 0;
      hyphens: manual;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
      }
    pre.numberSource { margin-left: 3em;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { font-weight: bold; } /* Alert */
    code span.an { font-style: italic; } /* Annotation */
    code span.cf { font-weight: bold; } /* ControlFlow */
    code span.co { font-style: italic; } /* Comment */
    code span.cv { font-style: italic; } /* CommentVar */
    code span.do { font-style: italic; } /* Documentation */
    code span.dt { text-decoration: underline; } /* DataType */
    code span.er { font-weight: bold; } /* Error */
    code span.in { font-style: italic; } /* Information */
    code span.kw { font-weight: bold; } /* Keyword */
    code span.pp { font-weight: bold; } /* Preprocessor */
    code span.wa { font-style: italic; } /* Warning */
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap" rel="stylesheet">

  <style>
  #title-block-header {
    display: none;
  }
  html {
    background-color: #202020;
  }
  body {
    @media (max-width: 800px) {
      max-width: 100%;
    }
    @media (min-width: 801px) {
      max-width: 80%;
    }
    @media (min-width: 1200px) {
       max-width: 60%;
     }
  }
  body {
    background-color: #2b2b2b;
    color: #a9b7c6;
    font-family: "Segoe UI", "Helvetica Neue", sans-serif;
    line-height: 1.6;
    padding: 2em;
  }

  h1, h2, h3, h4, h5, h6 {
    color: #ffffff;
    margin-top: 1.5em;
  }

  a,a:visited {
    color: #589df6;
    text-decoration: none;
  }
  a:hover {
    text-decoration: underline;
  }

  code {
    background-color: #3c3f41;
    color: #a9b7c6;
    padding: 0.2em 0.4em;
    border-radius: 4px;
    font-family: "Fira Code", monospace;
    font-size: 0.95em;
  }

  pre {
    background-color: #3c3f41;
    color: #a9b7c6;
    padding: 1em;
    border-radius: 6px;
    overflow-x: auto;
    font-family: "Fira Code", monospace;
    font-size: 0.95em;
  }
  code span.dt {
    text-decoration: none !important;
  }
  code span.co {
    color: #828d98 !important;
    font-style: normal;

  }
  </style>
</head>
<body>
<header id="title-block-header">
<h1 class="title">Autark</h1>
</header>
<h1 id="autark--a-self-contained-build-system-for-cc">Autark – A
self-contained build system for C/C++</h1>
<p><a href="https://github.com/Softmotions/autark">Autark source code
repository</a></p>
<p><strong>Autark is a self-contained build system that requires only
the <code>/bin/sh</code> and a <code>cc</code> compiler to
work!</strong></p>
<p>The goal of this project is to provide the community with a portable,
cross-platform build environment that has <strong>no external
dependencies</strong> and can be distributed <strong>directly with the
project’s source code</strong>. It eliminates version compatibility
issues common to traditional build systems, making software truly open
and self-contained.</p>
<p>The <code>build.sh</code> script automatically initializes the Autark
build system, and then proceeds with your project build. Autark handles
both internal and external project dependencies much more precisely and
cleanly than is typically done with Makefiles by hands. Build rules are
defined using a specialized DSL in Autark files, which is mostly
declarative in nature.</p>
<h2 id="key-features-of-autark">Key features of Autark</h2>
<ul>
<li>To initialize the project build system on the target system, nothing
is required except a C99-compliant compiler.</li>
<li>The build process does not modify the project's source tree.</li>
<li>Build rules are described using a simple and clear declarative DSL,
which is not a programming language.</li>
<li>The system provides extensive capabilities for extending the build
process with custom rules.</li>
<li>Parallel compilation of C/C++ source files is supported.</li>
<li>Support of an external project dependencies. Take a look on <a
href="https://github.com/Softmotions/iwnet">Softmotions/iwnet</a></li>
</ul>
<h2 id="installation">Installation</h2>
<p>To use Autark in your project, simply copy the latest version of
Autark:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> <span class="op">&lt;</span>root project folder<span class="op">&gt;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> <span class="at">-O</span> ./build.sh <span class="dt">\</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  https://raw.githubusercontent.com/Softmotions/autark/refs/heads/master/dist/build.sh</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> u+x ./build.sh</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Write Autark script then</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="ex">./build.sh</span></span></code></pre></div>
<p>The best way to get started is to look at the <a
href="https://github.com/Softmotions/autark-sample-project">Autark
sample project</a> or explore real-life projects that use Autark.</p>
<p>Built artifacts are placed in <code>./autark-cache</code> dir by
default.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">./build.sh</span> <span class="at">-h</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Usage</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Common</span> options:</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-V,</span> <span class="at">--verbose</span>               Outputs verbose execution info.</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-v,</span> <span class="at">--version</span>               Prints version info.</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-h,</span> <span class="at">--help</span>                  Prints usage help.</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="ex">autark</span> <span class="pp">[</span><span class="ss">sources_dir/command</span><span class="pp">]</span> <span class="pp">[</span><span class="ss">options</span><span class="pp">]</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Build</span> project in given sources dir.</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-H,</span> <span class="at">--cache</span><span class="op">=&lt;&gt;</span>              Project cache/build dir. Default: ./autark-cache</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-c,</span> <span class="at">--clean</span>                 Clean build cache dir.</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-l,</span> <span class="at">--options</span>               List of all available project options and their description.</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-J</span>  <span class="at">--jobs</span><span class="op">=&lt;&gt;</span>               Number of jobs used in c/cxx compilation tasks. Default: 4</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-D</span><span class="op">&lt;</span>option<span class="op">&gt;</span>[=<span class="op">&lt;</span>val<span class="op">&gt;</span>]          Set project build option.</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-I,</span> <span class="at">--install</span>               Install all built artifacts</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-R,</span> <span class="at">--prefix</span><span class="op">=&lt;&gt;</span>             Install prefix. Default: <span class="va">$HOME</span>/.local</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>        <span class="ex">--bindir=</span><span class="op">&lt;&gt;</span>             Path to <span class="st">&#39;bin&#39;</span> dir relative to a <span class="kw">`</span><span class="ex">prefix</span><span class="kw">`</span> dir. Default: bin</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="ex">...</span></span></code></pre></div>
<h2 id="brief-overview-of-autark">Brief overview of Autark</h2>
<p>Autark build artifacts, as well as rules dependency metadata, are
stored in a separate directory called the <em>autark-cache</em>. By
default, this is the <code>./autark-cache</code> directory at the root
of your project, but it can be changed using the <code>-H</code> or
<code>--cache</code> option.</p>
<p>The directory structure within the autark-cache mirrors the structure
of your project source tree. For all programs executed during the build
process, the current working directory is set to a corresponding
location inside the autark-cache. This behavior can be overridden using
the <code>in-source</code> directive. This approach reduces the risk of
modifying original source files and makes it easier to access
intermediate build artifacts during the various stages of the build
pipeline.</p>
<p>Autark script is a specialized DSL with modest capabilities, yet
sufficient for writing concise and elegant build scripts. The syntax is
simple and can be informally described as follows:</p>
<ul>
<li>A script consists of a set of rules and literals.</li>
<li>A rule follows this syntax:</li>
</ul>
<pre><code>
RULE:

  rule_name { RULE | LITERAL ... }

LITERAL:

  word | &#39;single quoted words&#39; | &quot;double quoted words&quot;
</code></pre>
<ul>
<li>Rules and literals are separated by <code>whitespaces</code>.</li>
<li>Every rule has a body enclosed in curly braces <code>{}</code>.</li>
<li>Rules form lists, similar to syntactic structures in Scheme or
Lisp.</li>
</ul>
<p>More formal syntax decription can be found here: <a
href="https://github.com/Softmotions/autark/blob/master/scriptx.leg">https://github.com/Softmotions/autark/blob/master/scriptx.leg</a></p>
<h2 id="sample-autark-script">Sample Autark script</h2>
<p>Below is a demonstration of an Autark script from the demo project:
<a
href="https://github.com/Softmotions/autark-sample-project">https://github.com/Softmotions/autark-sample-project</a>
Take a look and try building it!</p>
<p>You can also explore the following real-life C projects that use
Autark:</p>
<ul>
<li><a
href="https://github.com/Softmotions/iwnet">https://github.com/Softmotions/iwnet</a></li>
<li><a
href="https://github.com/Softmotions/ejdb">https://github.com/Softmotions/ejdb</a></li>
</ul>
<pre><code>git clone https://github.com/Softmotions/autark-sample-project
cd ./autark-sample-project
./build.sh</code></pre>
<div class="sourceCode" id="cb5"><pre
class="sourceCode cfg"><code class="sourceCode ini"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># https://github.com/Softmotions/autark-sample-project</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># This is a sample project demonstrating the Autark build system.</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co"># `meta` is a generic rule that sets all specified key/value pairs under the META_ prefix (except the `let` clause).</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co"># You can use any variables set in the meta section anywhere in your build scripts.</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="dt">meta {</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="dt">  </span><span class="co"># Available in the script context under the META_NAME key.</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="dt">  name { Hello }</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="dt">  artifact { hello }</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="dt">  description { Sample project demonstrating the Autark build system. }</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="dt">  website { https://github.com/Softmotions/autark-sample-project }</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="dt">  sources { https://github.com/Softmotions/autark-sample-project.git }</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="dt">  license { MIT }</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="dt">  version { 1.0.0 }</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Option is a small description of build switch which can be set by system env and or -D flag:</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="co"># ENABLE_DEBINFO=1 ./build.sh</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="co"># or ./build.sh -DENABLE_DEBINFO=1</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="dt">option { ENABLE_DEBINFO           Generate debuginfo even in release mode }</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="dt">option { HELLO_MSG                Hello message provided by libhello }</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="co"># The `check` rule takes a list of script files that should be located in the `.autark/` directory relative to</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="co"># the current Autark script file. A check script is a dash shell (`sh`) script that runs during the early stage</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="co"># of the build process (`init` phase). It verifies system requirements, locates required software or libraries,</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="co"># and sets variables that will be available in the Autark script. Check scripts typically use `autark set` to</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a><span class="co"># define variables used in the build process. You may specify multiple check rules.</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a><span class="dt">check {</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a><span class="dt">  system.sh</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Sets the BUILD_TYPE variable, using a previously defined value if available,</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a><span class="co"># or falling back to the default value &#39;Release&#39;.</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: Variables set by this rule are only available within the current Autark script and its included scripts.</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: `set` rules are evaluated lazily.</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a><span class="dt">set {</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a><span class="dt">  BUILD_TYPE</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a><span class="dt">  </span><span class="co"># Looks up the value of BUILD_TYPE in the current context, then in parent contexts,</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a><span class="dt">  </span><span class="co"># and finally in system environment variables.</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a><span class="dt">  </span><span class="co"># If not found, &#39;Release&#39; will be used as the default.</span></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a><span class="dt">  ${BUILD_TYPE Release}</span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a><span class="dt">if { !defined { HELLO_MSG }</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a><span class="dt">  set { HELLO_MSG &#39;Hello from libhello!&#39; }</span></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a><span class="dt">echo {</span></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a><span class="dt">  </span><span class="co"># This message is printed in &#39;build&#39; phase</span></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a><span class="dt">  Building my hello app...</span></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a><span class="dt">  </span><span class="co"># Printed in first build &#39;init&#39; stage</span></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a><span class="dt">  </span><span class="co">#init {</span></span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a><span class="dt">  </span><span class="co">#  Project build initialized</span></span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a><span class="dt">  </span><span class="co">#}</span></span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a><span class="dt">set {</span></span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a><span class="dt">  CFLAGS</span></span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a><span class="dt">  </span><span class="co"># Just build the compiler flag like: -DBUILD_TYPE=Release</span></span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a><span class="dt">  </span><span class="co"># ^{...} is a string join rule.</span></span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a><span class="dt">  </span><span class="co"># Note: the space after: &#39;-DBUILD_TYPE=&#39; is required by syntax rules of Autark script.</span></span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a><span class="dt">  ^{-DBUILD_TYPE</span><span class="ot">=</span><span class="st"> ${BUILD_TYPE}}</span></span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a><span class="dt">  </span><span class="co"># Conditions can be placed anywhere in the build script.</span></span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a><span class="dt">  </span><span class="co"># This effectively performs tree shaking on the build script&#39;s syntax tree.</span></span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a><span class="dt">  if { prefix { ${BUILD_TYPE} Release }</span></span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a><span class="dt">    -O2</span></span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a><span class="dt">    </span><span class="co"># The condition if { ${...} } evaluates to true if and only if</span></span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a><span class="dt">    </span><span class="co"># the argument is not an empty string and is not equal to &quot;0&quot;.</span></span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a><span class="dt">    if { ${ENABLE_DEBINFO}</span></span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a><span class="dt">      -g</span></span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a><span class="dt">    }</span></span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a><span class="dt">  } else {</span></span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a><span class="dt">    -DDEBUG</span><span class="ot">=</span><span class="dv">1</span></span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a><span class="dt">    -O0</span></span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a><span class="dt">    -g</span></span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a><span class="dt">  }</span></span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a><span class="dt">  </span><span class="co"># Merge this set of flags with any previously defined CFLAGS if any.</span></span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a><span class="dt">  </span><span class="co"># Note: The `..` prefix indicates that the elements of ${CFLAGS}</span></span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a><span class="dt">  </span><span class="co"># will be added to this set, similar to spread syntax in JavaScript.</span></span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a><span class="dt">  ..${CFLAGS}</span></span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a><span class="co"># Note LDFLAGS can be specified in system env variable: `LDFLAGS=... ./build.sh`</span></span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a><span class="dt">set {</span></span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a><span class="dt">  LDFLAGS</span></span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a><span class="dt">  ..${LDFLAGS}</span></span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a><span class="dt">set {</span></span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a><span class="dt">  SOURCES</span></span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a><span class="dt">  main.c</span></span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a><span class="dt">  utils.c</span></span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a><span class="co"># Now let&#39;s define a rule for compiling C source files.</span></span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a><span class="co"># The generic form of the `cc` rule:</span></span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a><span class="co"># cc {</span></span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a><span class="co">#   SOURCES</span></span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a><span class="co">#   [FLAGS]</span></span>
<span id="cb5-103"><a href="#cb5-103" aria-hidden="true" tabindex="-1"></a><span class="co">#   [COMPILER]</span></span>
<span id="cb5-104"><a href="#cb5-104" aria-hidden="true" tabindex="-1"></a><span class="co">#   [consumes { ... }]  Outputs of other rules this one depends on</span></span>
<span id="cb5-105"><a href="#cb5-105" aria-hidden="true" tabindex="-1"></a><span class="co">#   [objects { NAME }]  Defines the variable name where the list of compiled object files is stored. Defaults to CC_OBJS.</span></span>
<span id="cb5-106"><a href="#cb5-106" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb5-107"><a href="#cb5-107" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb5-108"><a href="#cb5-108" aria-hidden="true" tabindex="-1"></a><span class="co"># This rule compiles the given source files and produces a set of object (.o) files.</span></span>
<span id="cb5-109"><a href="#cb5-109" aria-hidden="true" tabindex="-1"></a><span class="dt">cc {</span></span>
<span id="cb5-110"><a href="#cb5-110" aria-hidden="true" tabindex="-1"></a><span class="dt">  ${SOURCES}</span></span>
<span id="cb5-111"><a href="#cb5-111" aria-hidden="true" tabindex="-1"></a><span class="dt">  </span><span class="co"># Here we intentionally show an anonymous `set {..}` using `_` as a placeholder for the variable name.</span></span>
<span id="cb5-112"><a href="#cb5-112" aria-hidden="true" tabindex="-1"></a><span class="dt">  </span><span class="co"># This is used to extend CFLAGS with additional arguments directly in-place.</span></span>
<span id="cb5-113"><a href="#cb5-113" aria-hidden="true" tabindex="-1"></a><span class="dt">  set { _ ${CFLAGS} -I ./libhello }</span></span>
<span id="cb5-114"><a href="#cb5-114" aria-hidden="true" tabindex="-1"></a><span class="dt">  </span><span class="co"># Note: CC is set by system.sh check script.</span></span>
<span id="cb5-115"><a href="#cb5-115" aria-hidden="true" tabindex="-1"></a><span class="dt">  ${CC}</span></span>
<span id="cb5-116"><a href="#cb5-116" aria-hidden="true" tabindex="-1"></a><span class="dt">  consumes {</span></span>
<span id="cb5-117"><a href="#cb5-117" aria-hidden="true" tabindex="-1"></a><span class="dt">    </span><span class="co"># The output of the &#39;configure&#39; rule applied to hello.h.in</span></span>
<span id="cb5-118"><a href="#cb5-118" aria-hidden="true" tabindex="-1"></a><span class="dt">    libhello/hello.h</span></span>
<span id="cb5-119"><a href="#cb5-119" aria-hidden="true" tabindex="-1"></a><span class="dt">  }</span></span>
<span id="cb5-120"><a href="#cb5-120" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span>
<span id="cb5-121"><a href="#cb5-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-122"><a href="#cb5-122" aria-hidden="true" tabindex="-1"></a><span class="co"># Include the scipt which build libhello.a static library</span></span>
<span id="cb5-123"><a href="#cb5-123" aria-hidden="true" tabindex="-1"></a><span class="dt">include { libhello/Autark }</span></span>
<span id="cb5-124"><a href="#cb5-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-125"><a href="#cb5-125" aria-hidden="true" tabindex="-1"></a><span class="co"># Now link the final executable application.</span></span>
<span id="cb5-126"><a href="#cb5-126" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: LIBHELLO_A variable is set by child &#39;libhello/Autark&#39;</span></span>
<span id="cb5-127"><a href="#cb5-127" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb5-128"><a href="#cb5-128" aria-hidden="true" tabindex="-1"></a><span class="co"># The generic form of the `run` rule:</span></span>
<span id="cb5-129"><a href="#cb5-129" aria-hidden="true" tabindex="-1"></a><span class="co"># run {</span></span>
<span id="cb5-130"><a href="#cb5-130" aria-hidden="true" tabindex="-1"></a><span class="co">#   [always]</span></span>
<span id="cb5-131"><a href="#cb5-131" aria-hidden="true" tabindex="-1"></a><span class="co">#   [exec  {...}] ...</span></span>
<span id="cb5-132"><a href="#cb5-132" aria-hidden="true" tabindex="-1"></a><span class="co">#   [shell {...}] ...</span></span>
<span id="cb5-133"><a href="#cb5-133" aria-hidden="true" tabindex="-1"></a><span class="co">#   [consumes{...}]</span></span>
<span id="cb5-134"><a href="#cb5-134" aria-hidden="true" tabindex="-1"></a><span class="co">#   [produces{...}]</span></span>
<span id="cb5-135"><a href="#cb5-135" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb5-136"><a href="#cb5-136" aria-hidden="true" tabindex="-1"></a><span class="dt">run {</span></span>
<span id="cb5-137"><a href="#cb5-137" aria-hidden="true" tabindex="-1"></a><span class="dt">  exec { ${CC} -static ${LDFLAGS} -o ${META_ARTIFACT} ${CC_OBJS} ${LIBHELLO_A} }</span></span>
<span id="cb5-138"><a href="#cb5-138" aria-hidden="true" tabindex="-1"></a><span class="dt">  consumes {</span></span>
<span id="cb5-139"><a href="#cb5-139" aria-hidden="true" tabindex="-1"></a><span class="dt">    ${CC_OBJS}</span></span>
<span id="cb5-140"><a href="#cb5-140" aria-hidden="true" tabindex="-1"></a><span class="dt">    ${LIBHELLO_A}</span></span>
<span id="cb5-141"><a href="#cb5-141" aria-hidden="true" tabindex="-1"></a><span class="dt">  }</span></span>
<span id="cb5-142"><a href="#cb5-142" aria-hidden="true" tabindex="-1"></a><span class="dt">  produces {</span></span>
<span id="cb5-143"><a href="#cb5-143" aria-hidden="true" tabindex="-1"></a><span class="dt">    ${META_ARTIFACT}</span></span>
<span id="cb5-144"><a href="#cb5-144" aria-hidden="true" tabindex="-1"></a><span class="dt">  }</span></span>
<span id="cb5-145"><a href="#cb5-145" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span>
<span id="cb5-146"><a href="#cb5-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-147"><a href="#cb5-147" aria-hidden="true" tabindex="-1"></a><span class="co"># Installs executable artifact to the INSTALL_BIN_DIR relative to installation prefix.</span></span>
<span id="cb5-148"><a href="#cb5-148" aria-hidden="true" tabindex="-1"></a><span class="dt">install {</span></span>
<span id="cb5-149"><a href="#cb5-149" aria-hidden="true" tabindex="-1"></a><span class="dt">  ${INSTALL_BIN_DIR}</span></span>
<span id="cb5-150"><a href="#cb5-150" aria-hidden="true" tabindex="-1"></a><span class="dt">  ${META_ARTIFACT}</span></span>
<span id="cb5-151"><a href="#cb5-151" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span></code></pre></div>
<p><a
href="https://github.com/Softmotions/autark-sample-project">https://github.com/Softmotions/autark-sample-project</a></p>
<h2 id="autark-concepts-and-build-lifecycle">Autark concepts and build
lifecycle</h2>
<p>Autark executes rules defined in Autark script files. The build
process goes through the following stages: <code>init</code>,
<code>setup</code>, <code>build</code>, and <code>post_build</code>.</p>
<p>For each stage, the rules specified in the scripts are executed
sequentially, from top to bottom. However, during the <code>build</code>
stage, some rules may depend on the results of other rules. In such
cases, the execution order is adjusted to ensure that dependencies are
resolved correctly.</p>
<p>The project build process goes through the following phases:</p>
<h3 id="init">init</h3>
<p>Initialization of the build process.</p>
<p>During the <code>init</code> phase, the following steps occur:</p>
<ul>
<li>Autark build script files are parsed.</li>
<li>Initialization logic for rules is executed in sequence so it makes
sence order of <code>set</code>, <code>check</code>, <code>if</code> in
build script.</li>
<li>Based on the current state of variables, <em>tree shaking</em> is
applied to the syntax tree of the overall Autark build script. As a
result, all conditional <code>if</code> rules and certain helper rules
such as <code>in-source</code> and <code>foreach</code> are removed from
the syntax tree completely.</li>
</ul>
<h3 id="setup">setup</h3>
<p>At this stage, the hierarchical structure of rules (the syntax tree)
is finalized and will no longer change. This phase prepares the rules
for the main <code>build</code> stage of the process. You could think of
this phase as a pre-build step of main build phase.</p>
<h3 id="build">build</h3>
<p>This is the main phase of the project build process, where the actual
work of the build rules is performed. During this phase, dependencies
between rules are tracked and established, as well as dependencies on
filesystem objects, project source files, environment variables, and
more.</p>
<p>The execution order of rules is determined by their dependencies. A
rule typically will not perform its main function if all of its
dependencies have already been satisfied and the rule has been
previously executed.</p>
<h3 id="post-build">post-build</h3>
<p>This phase is executed after the <code>build</code> phase has
completed successfully. It is primarily used for rules that install the
built project artifacts.</p>
<h1 id="known-limitations-of-autark">Known Limitations of Autark</h1>
<ul>
<li>If the syntax of an Autark script is invalid, the resulting error
message may be vague or imprecise. This is due to the use of the
<code>leg</code> PEG parser generator, which can produce generic error
reports for malformed input.</li>
</ul>
<h1 id="autark-script-rules">Autark script rules</h1>
<ul>
<li><a href="#meta-">meta</a></li>
<li><a href="#option-">option</a></li>
<li><a href="#check-">check</a></li>
<li><a href="#set-">set</a></li>
<li><a href="#env-">env</a></li>
<li><a href="#-variable-evaluation">${}</a></li>
<li><a href="#-program-output-evaluation">@{}</a></li>
<li><a href="#-expressions-concatenation">^{}</a></li>
<li><a href="#if--condition">if</a></li>
<li><a href="#echo-">echo</a></li>
<li><a href="#configure-">configure</a></li>
<li><a href="#s--ss--c--cc---path-helpers">path helpers</a></li>
<li><a href="#run-">run</a></li>
<li><a href="#in-sources-">in-sources</a></li>
<li><a href="#run-on-install-">run-on-install</a></li>
<li><a href="#foreach-">foreach</a></li>
<li><a href="#cc-----cxx---">cc/cxx</a></li>
<li><a href="#library-">library</a></li>
<li><a href="#install-">install</a></li>
</ul>
<h2 id="meta-">meta {...}</h2>
<p>Sets script variables using a simple convention: each variable name
is automatically prefixed with <code>META_</code>. These variables are
evaluated during the <code>init</code> phase of the build.</p>
<p>The <code>meta</code> rule is recommended for defining global
variables such as project version, name, description, maintainer contact
information, etc.</p>
<p>These meta-variables are especially convenient to use in
<code>configure</code> rules.</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode cfg"><code class="sourceCode ini"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="dt">meta {</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="dt">  </span><span class="kw">[&lt;VARNAME SUFFIX&gt; { ... }]</span><span class="dt"> ...</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="dt">  let { &lt;VARNAME&gt; ... }</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span></code></pre></div>
<p>If variable is defined using the <code>let</code> clause inside
<code>meta</code>, the <code>META_</code> prefix is not added to its
name.</p>
<h2 id="option-">option {...}</h2>
<div class="sourceCode" id="cb7"><pre
class="sourceCode cfg"><code class="sourceCode ini"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="dt">option { &lt;OPTION NAME&gt; </span><span class="kw">[OPTION DESCRIPTION]</span><span class="dt"> }</span></span></code></pre></div>
<p>This rule declares a build option. Build options are variables set at
the start of the build to configure the desired output. These variables
can be defined either as environment variables:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="va">BUILD_TYPE</span><span class="op">=</span>Release <span class="va">BUILD_SHARED_LIBS</span><span class="op">=</span>1 <span class="ex">./build.sh</span></span></code></pre></div>
<p>or as command-line arguments:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">./build.sh</span> <span class="at">-DBUILD_TYPE</span><span class="op">=</span>Release <span class="at">-DBUILD_SHARED_LIBS</span><span class="op">=</span>1</span></code></pre></div>
<p>If you don't use the variable values in shell scripts during the
build, the second method is preferred - it avoids polluting the
environment and prevents these variables from leaking into subprocesses
where they might be unnecessary or accidentally override something.</p>
<p>To list all documented build options, use:</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">./build.sh</span> <span class="at">-l</span></span></code></pre></div>
<h2 id="check-">check {...}</h2>
<p>This construct is the workhorse for checking system configuration and
capabilities before compiling the project. Checks are performed using
<code>dash</code> shell scripts.</p>
<p>The main purpose of a check script is to set variables used in Autark
scripts. Additionally, check scripts can declare dependencies on files
and environment variables, and are automatically re-executed when some
of dependencies are changed. (This is handled by invoking the
<code>autark</code> command from within the check script.)</p>
<p>You can find a collection of useful check scripts at: <a
href="https://github.com/Softmotions/autark/tree/master/check_scripts">https://github.com/Softmotions/autark/tree/master/check_scripts</a>
Feel free to copy any scripts that are relevant to your project.</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode cfg"><code class="sourceCode ini"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="dt">check {</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="dt">  </span><span class="kw">[SCRIPT]</span><span class="dt"> ...</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span></code></pre></div>
<p>Check scripts must be located in the <code>./autark</code> directory
relative to the script that references them, or in similar directories
of parent scripts.</p>
<p>For small projects, it is convenient to place all check scripts in
the <code>.autark</code> directory at the root of your project.</p>
<p>Within the context of a check script, the <code>autark</code> command
is available. It allows the script to define variables or register
dependencies - so that if any of those dependencies change, the check
script will be automatically re-executed.</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">autark</span> set <span class="op">&lt;</span>key<span class="op">&gt;</span>=<span class="op">&lt;</span>value<span class="op">&gt;</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Sets</span> key/value pair as output for check script.</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="ex">autark</span> dep <span class="op">&lt;</span>file<span class="op">&gt;</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Registers</span> a given file as dependency for check script.</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="ex">autark</span> env <span class="op">&lt;</span>env<span class="op">&gt;</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Registers</span> a given environment variable as dependency for check script.</span></code></pre></div>
<p>Check script example:</p>
<p><a
href="https://github.com/Softmotions/autark/blob/master/check_scripts/test_symbol.sh">https://github.com/Softmotions/autark/blob/master/check_scripts/test_symbol.sh</a></p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/sh</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="va">SYMBOL</span><span class="op">=</span><span class="va">$1</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="va">HEADER</span><span class="op">=</span><span class="va">$2</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="va">DEFINE_VAR</span><span class="op">=</span><span class="va">$3</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="fu">usage()</span> <span class="kw">{</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  <span class="bu">echo</span> <span class="st">&quot;Usage test_symbol.sh &lt;SYMBOL&gt; &lt;HEADER&gt; &lt;DEFINE_VAR&gt;&quot;</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="bu">exit</span> 1</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span> <span class="ot">-n</span> <span class="st">&quot;</span><span class="va">$SYMBOL</span><span class="st">&quot;</span> <span class="bu">]</span> <span class="kw">||</span> <span class="ex">usage</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span> <span class="ot">-n</span> <span class="st">&quot;</span><span class="va">$HEADER</span><span class="st">&quot;</span> <span class="bu">]</span> <span class="kw">||</span> <span class="ex">usage</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span> <span class="ot">-n</span> <span class="st">&quot;</span><span class="va">$DEFINE_VAR</span><span class="st">&quot;</span> <span class="bu">]</span> <span class="kw">||</span> <span class="ex">usage</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&gt;</span> <span class="st">&quot;test_symbol.c&quot;</span> <span class="op">&lt;&lt;EOF</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="st">#include &lt;</span><span class="va">$HEADER</span><span class="st">&gt;</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="st">int main() {</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="st">#ifdef </span><span class="va">$SYMBOL</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a><span class="st">  return 0; // Symbol is a macro</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="st">#else</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="st">  (void)</span><span class="va">$SYMBOL</span><span class="st">; // Symbol might be a function or variable</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a><span class="st">  return 0;</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a><span class="st">#endif</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">${CC</span><span class="op">:-</span>cc<span class="va">}</span> <span class="at">-Werror</span> ./test_symbol.c<span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>  <span class="ex">autark</span> set <span class="st">&quot;</span><span class="va">$DEFINE_VAR</span><span class="st">=1&quot;</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Re-run script if CC system environment changed</span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a><span class="ex">autark</span> env CC</span></code></pre></div>
<p>The results of check script execution can also be used not only in
variables but in project header templates, such as
<code>config.h.in</code>. This is typically done via
<code>configure</code> rules in the Autark script:</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode cfg"><code class="sourceCode ini"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="dt">check {</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="dt">  test_symbol.sh { CLOCK_MONOTONIC time.h IW_HAVE_CLOCK_MONOTONIC }</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="dt">...</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="dt">configure {</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="dt">  config.h.in</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span></code></pre></div>
<p>Autark will replace <code>//autarkdef</code> lines with the
appropriate #define or comment them out, depending on whether the
variable is defined or not.</p>
<p>config.h.in:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">//autarkdef IW_HAVE_CLOCK_MONOTONIC 1</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span></code></pre></div>
<p>Or you may use variable directly in CFLAGS</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode cfg"><code class="sourceCode ini"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="dt">set {</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="dt"> CFLAGS</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="dt"> if { ${IW_HAVE_CLOCK_MONOTONIC}</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="dt">   -DIW_HAVE_CLOCK_MONOTONIC</span><span class="ot">=</span><span class="dv">1</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="dt"> }</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="dt"> ...</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span></code></pre></div>
<h2 id="set-">set {...}</h2>
<p>The <code>set</code> rule assigns a value to a variable in the build
script.</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode cfg"><code class="sourceCode ini"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="dt">set {</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="dt">   | NAME</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="dt">   | _</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="dt">   | parent { NAME }</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="dt">   | root { NAME }</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="dt">   </span><span class="kw">[VALUES]</span><span class="dt"> ...</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span></code></pre></div>
<p><code>set</code> is a lazily evaluated rule - the value of set is
only computed if the variable or expression is actually used.</p>
<p>The most common form is <code>set { NAME [VALUES]... }</code></p>
<p>Note that in Autark, all variables are either strings or lists. A
list is just a string internally, encoded in a special form:
<code>\1VAL_ONE\1VAL_TWO\1...</code>, where list values are separated by
the <code>\1</code> character.</p>
<p>If there is only one value, e.g. <code>set { foo bar }</code>, then
the variable foo is evaluated as <code>"bar"</code> string. If you write
<code>set { foo bar baz }</code>, the value of <code>foo</code> becomes
a list, encoded as <code>\1bar\1baz</code>.</p>
<p><code>Set</code> is an expression actually and can be used inline in
other constructs. For example:</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode cfg"><code class="sourceCode ini"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="dt">cc {</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="dt">  ${SOURCES}</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="dt">  set { _ ${CFLAGS} -I./libhello }</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="dt">  ...</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span></code></pre></div>
<p>Here, <code>CFLAGS</code> is extended with an additional flag
<code>-I./libhello</code> directly in-place using an anonymous set where
<code>_</code> used in place of variable name.</p>
<p>By default, variables defined with set are visible only in the
current Autark script and any child scripts included by
<code>include</code> directive.</p>
<p>To define or modify a variable in the parent's script context,
use:</p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode cfg"><code class="sourceCode ini"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="dt">set {</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="dt">  parent {</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="dt">    NAME</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="dt">  }</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="dt">  ...</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span></code></pre></div>
<p>To define a variable in the root script context:</p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode cfg"><code class="sourceCode ini"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="dt">set {</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="dt">  root {</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="dt">    NAME</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="dt">  }</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="dt">  ...</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span></code></pre></div>
<h2 id="env-">env {...}</h2>
<p>Similar to <code>set</code>, but sets an <strong>environment
variable</strong> for the build process using <code>setenv(3)</code> at
the operating system level.</p>
<p>Unlike <code>set</code>, the value of this rule is evaluated at the
time it is executed, which happens during the <code>setup</code> phase
of the build.</p>
<h2 id="-variable-evaluation">${...} Variable evaluation</h2>
<div class="sourceCode" id="cb21"><pre
class="sourceCode cfg"><code class="sourceCode ini"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="dt">${VARIABLE </span><span class="kw">[DEFAULT]</span><span class="dt">}`</span></span></code></pre></div>
<p>The expression <code>${VARIABLE [DEFAULT]}</code> is used when the
value of a variable needs to be passed as an argument to another rule.
If the variable is not defined in the current script context, the
<code>DEFAULT</code> value will be used if provided.</p>
<h2 id="-program-output-evaluation">@{...} Program output
evaluation</h2>
<div class="sourceCode" id="cb22"><pre
class="sourceCode cfg"><code class="sourceCode ini"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="dt">@{PROGRAM </span><span class="kw">[ARG1 ARG2 ...]</span><span class="dt">}</span></span></code></pre></div>
<p>Invokes the specified program <code>PROGRAM</code> and returns its
standard output as a string.</p>
<h3 id="example">Example:</h3>
<div class="sourceCode" id="cb23"><pre
class="sourceCode cfg"><code class="sourceCode ini"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="dt">set {</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="dt">  LDFLAGS</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="dt">  ..@{${PKGCONF pkgconf} --libs --static libcurl}</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="dt">  ..${LDFLAGS}</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span></code></pre></div>
<p>In this example, the output of
<code>pkgconf --libs --static libcurl</code> is appended to the
<code>LDFLAGS</code> list. <strong>Note</strong> what <code>..</code> in
pkgconf instruction means what space separated output of pkgconf
programm will be converted to list and merged with LDFLAGS list.</p>
<h2 id="-expressions-concatenation">^{...} Expressions
concatenation</h2>
<div class="sourceCode" id="cb24"><pre
class="sourceCode cfg"><code class="sourceCode ini"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="dt">^{EXPR1 </span><span class="kw">[EXPR2]</span><span class="dt">...}</span></span></code></pre></div>
<p>Concatenates expressions output. Here we encounter an important
syntactic rule in Autark scripts: all rules must be separated by
whitespace. Because of this, the following code is invalid:</p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode cfg"><code class="sourceCode ini"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="dt">set {</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="dt"> CFLAGS</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="dt"> -DBUILD_TYPE</span><span class="ot">=</span><span class="st">${BUILD_TYPE} # Wrong!</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span></code></pre></div>
<p>In this case, the Autark interpreter treats
<code>-DBUILD_TYPE=$</code> as a rule name, which is not what we
intend.</p>
<p>To correctly construct the string
<code>-DBUILD_TYPE=${BUILD_TYPE}</code> using the variable value from
the script context, you must use the string concatenation rule:</p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode cfg"><code class="sourceCode ini"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="dt">set {</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="dt">  CFLAGS</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="dt">  ^{-DBUILD_TYPE</span><span class="ot">=</span><span class="st"> ${BUILD_TYPE}}</span></span></code></pre></div>
<p>Note: the space between <code>-DBUILD_TYPE=</code> and
<code>${BUILD_TYPE}</code> is required.</p>
<h2 id="if--condition">if {...} condition</h2>
<p>Conditional directive.</p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode cfg"><code class="sourceCode ini"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="dt">  if {</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="dt">    CONDITION_RULE</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="dt">    EXPR1</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="dt">  } </span><span class="kw">[  else { EXPR2 } ]</span></span></code></pre></div>
<p>Examples:</p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode cfg"><code class="sourceCode ini"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="dt">if { or { ${BUILD_BINDING_JNI} ${BUILD_BINDING_NODEJS} }</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="dt">  include { bindings/Autark }</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="dt">...</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="dt">if { ${EJDB_BUILD_SHARED_LIBS}</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="dt">  if {!defined {SYSTEM_DARWIN}</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="dt">    set {</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="dt">      LIBEJDB_SO_BASE</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="dt">      libejdb2.so</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a><span class="dt">    }</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="dt">  }</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="dt">  ...</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span></code></pre></div>
<p>If the condition <code>CONDITION_RULE</code> evaluates to a
<code>truthy</code> value, the entire <code>if</code> expression is
replaced by <code>EXPR1</code> in the Autark script’s instruction tree.
Otherwise, if an <code>else</code> block is provided, it will be
replaced by <code>EXPR2</code>.</p>
<h3 id="conditions">Conditions</h3>
<p>Exclamation mark <code>!</code> means expression result negation,
when trufly evaluated expressions became false.</p>
<p><code>[!]${EXPR}</code> <br/>Evaluates as truthy in any of the
following cases:</p>
<ul>
<li>The result of <code>EXPR</code> is a non-empty string and not equal
to <code>"0"</code>.</li>
<li>The result is a list with a single element that is not empty and not
<code>"0"</code>.</li>
<li>The result is a list with more than one element, regardless of
content.</li>
</ul>
<p><code>[!]defined { VARIABLE [VARIABLE2 ...] }</code> <br/>Truthy if
any of specified variables is defined in the current script context.</p>
<p><code>[!]eq { EXPR1 EXPR2 }</code> <br/>Truthy if the string value of
<code>EXPR1</code> is equal to <code>EXPR2</code>.</p>
<p><code>[!]prefix { EXPR1 EXPR2 }</code> <br/>Truthy if the string
value of EXPR2 is a prefix of EXPR1.</p>
<p><code>[!]contains { EXPR1 EXPR2 }</code> <br/>Truthy if EXPR1
contains EXPR2 as a substring.</p>
<p><code>[!]or { EXPR1 ... EXPRN }</code> <br/>Truthy if any of the
expressions inside the directive is truthy (according to the rules
defined above).</p>
<p><code>[!]and { EXPR1 ... EXPRN }</code> <br/>Truthy if all
expressions inside the directive are truthy.</p>
<p><strong>Please Note:</strong> Autark syntax does not support
<code>else if</code> constructs.</p>
<h2 id="error--abort-build-and-report-error">error {...} Abort build and
report error</h2>
<p>Typical example <code>error</code> directive usage:</p>
<div class="sourceCode" id="cb29"><pre
class="sourceCode cfg"><code class="sourceCode ini"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="dt">if { !defined{ PTHREAD_LFLAG }</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="dt">  error { Pthreads implementation is not found! }</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span></code></pre></div>
<h2 id="echo-">echo {...}</h2>
<p>Prints arbitrary information to the console (standard output,
<code>stdout</code>).</p>
<div class="sourceCode" id="cb30"><pre
class="sourceCode cfg"><code class="sourceCode ini"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="dt"> echo {</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="dt">  ...</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="dt">  | build { ... }</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="dt">  | setup { ... }</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="dt">  | init  { ... }</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="dt"> }</span></span></code></pre></div>
<p>You can optionally specify the build phase (<code>init</code>,
<code>setup</code>, or <code>build</code>) during which the output of
the echo directive should appear. By default, it is printed during the
build phase.</p>
<p><em>Please note: Variables in Autark defined by <code>set</code> rule
are lazy evaluated, so by using <code>echo</code> you may indirectly
change behaviour and effectiveness of your build process</em></p>
<p>Example:</p>
<div class="sourceCode" id="cb31"><pre
class="sourceCode cfg"><code class="sourceCode ini"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="dt">echo {</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="dt">  CFLAGS</span><span class="ot">=</span><span class="st"> ${CFLAGS}</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="dt">  LDFLAGS</span><span class="ot">=</span><span class="st"> ${LDFLAGS}</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span></code></pre></div>
<p>This will print the current values of the CFLAGS and LDFLAGS
variables.</p>
<h2 id="configure-">configure {...}</h2>
<p>The <code>configure</code> rule acts as a preprocessor for text files
and C/C++ source templates, replacing specific sections with values of
variables from the current script context.</p>
<div class="sourceCode" id="cb32"><pre
class="sourceCode cfg"><code class="sourceCode ini"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="dt">configure {</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="dt">  mylib.pc.in</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span></code></pre></div>
<p>Autark tracks all variables used during the substitution process. If
any of those variables change, <strong>the entire</strong> configure
rule will be re-executed. This is why it's recommended to configure each
file in a separate configure rule whenever possible.</p>
<p>Incorrect:</p>
<div class="sourceCode" id="cb33"><pre
class="sourceCode cfg"><code class="sourceCode ini"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="dt">configure {</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="dt">  mylib.pc.in</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="dt">  config.h.in</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span></code></pre></div>
<p>Correct:</p>
<div class="sourceCode" id="cb34"><pre
class="sourceCode cfg"><code class="sourceCode ini"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="dt">configure {</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="dt">  mylib.pc.in</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="dt">configure {</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="dt">  config.h.in</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span></code></pre></div>
<h3 id="-substitutions">@...@ Substitutions</h3>
<p>Text fragments enclosed in <code>@</code> symbols are interpreted as
variable names and replaced with their corresponding values. If a
variable is not defined, the expression is replaced with an empty
string.</p>
<p>Example libejdb2.pc.in:</p>
<pre class="pc"><code>exec_prefix=@INSTALL_PREFIX@/@INSTALL_BIN_DIR@
libdir=@INSTALL_PREFIX@/@INSTALL_LIB_DIR@
includedir=@INSTALL_PREFIX@/@EJDB_PUBLIC_HEADERS_DESTINATION@
artifact=@META_NAME@

Name: @META_NAME@
Description: @META_DESCRIPTION@
URL: @META_WEBSITE@
Version: @META_VERSION@
Libs: -L${libdir} -l${artifact}
Requires: libiwnet
Libs.private: @LDFLAGS_PKGCONF@
Cflags: -I@INSTALL_PREFIX@/@INSTALL_INCLUDE_DIR@ -I${includedir}
Cflags.private: -DIW_STATIC</code></pre>
<h3 id="autarkdef-for-cc-headers">//autarkdef for C/C++ Headers</h3>
<p>For C/C++ header files, the <code>//autarkdef</code> directive is a
convenient way to conditionally generate <code>#define</code> statements
based on variable presence.</p>
<p><strong>Basic form:</strong></p>
<div class="sourceCode" id="cb36"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co">//autarkdef VAR_NAME</span></span></code></pre></div>
<p>If <code>VAR_NAME</code> is defined, this will be replaced with:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define VAR_NAME</span></span></code></pre></div>
<p><strong>With string value:</strong></p>
<div class="sourceCode" id="cb38"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co">//autarkdef VAR_NAME &quot;</span></span></code></pre></div>
<p>If <code>VAR_NAME</code> is defined, this becomes:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define VAR_NAME </span><span class="st">&quot;VAR_VALUE&quot;</span></span></code></pre></div>
<p><strong>With num value:</strong></p>
<div class="sourceCode" id="cb40"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co">//autarkdef VAR_NAME 1</span></span></code></pre></div>
<p>If <code>VAR_NAME</code> is defined, this becomes:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define VAR_NAME </span><span class="dv">1</span></span></code></pre></div>
<h2 id="s--ss--c--cc---path-helpers"><code>S</code> / <code>SS</code> /
<code>C</code> / <code>CC</code> / <code>%</code> Path Helpers</h2>
<p>These small helper rules are useful for computing file paths in build
scripts. They help avoid hardcoding paths that may depend on the current
location of the project's source code.</p>
<h3 id="s-">S {...}</h3>
<p>Computes the <strong>absolute path</strong> of the given argument(s)
relative to the <strong>project root</strong>. If multiple arguments are
provided, they are concatenated into a single path string.</p>
<div class="sourceCode" id="cb42"><pre
class="sourceCode cfg"><code class="sourceCode ini"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="dt">  </span><span class="co"># &lt;project root&gt;/foo</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="dt">  S{foo}</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="dt">  </span><span class="co">#&lt;project root&gt;/foo/bar/baz</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="dt">  S{foo bar baz}</span></span></code></pre></div>
<h3 id="ss-">SS {...}</h3>
<p>Same as <code>S</code>, but relative to the directory where the
current script is located.</p>
<h3 id="c-">C {...}</h3>
<p>Computes the <strong>absolute path</strong> to the argument(s)
relative to the <strong>project-wide autark-cache dir</strong>.</p>
<h3 id="cc-">CC {...}</h3>
<p>Computes the <strong>absolute path</strong> relative to the
<strong>local cache directory</strong> of the current script. This is
the default working directory for tools and commands that operate on
build artifacts.</p>
<h3 id="-">% {...}</h3>
<p>Returns the <code>basename</code> of the given filename changing its
extension optionally.</p>
<div class="sourceCode" id="cb43"><pre
class="sourceCode cfg"><code class="sourceCode ini"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="dt">%{ PATH </span><span class="kw">[ NEW_FILE_EXT ]</span><span class="dt"> }</span></span></code></pre></div>
<div class="sourceCode" id="cb44"><pre
class="sourceCode cfg"><code class="sourceCode ini"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Returns &#39;main&#39;</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="dt">%{main.o}</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Returns &#39;hello.c&#39;</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="dt">%{hello.x .c}</span></span></code></pre></div>
<h2 id="run-">run {...}</h2>
<p>The <code>run</code> rule is the most powerful construct in the
Autark system. It allows you to define custom build actions and their
dependency chains.</p>
<p>In C/C++ projects, <code>run</code> is typically used to build static
and dynamic libraries, executables, and other artifacts - but it can
support virtually any custom pipeline.</p>
<div class="sourceCode" id="cb45"><pre
class="sourceCode cfg"><code class="sourceCode ini"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="dt">run {</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="dt">  </span><span class="kw">[always]</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="dt">  </span><span class="kw">[exec  { CMD [CMD_ARGS...]</span><span class="dt"> }] ...</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="dt">  </span><span class="kw">[shell { CMD [CMD_ARGS...]</span><span class="dt"> }] ...</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="dt">  </span><span class="kw">[consumes{ CONSUMED_FILES... }]</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="dt">  </span><span class="kw">[produces{ PRODUCED_FILES... }]</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span></code></pre></div>
<p>The <code>consumes</code> section defines the <strong>input
dependencies</strong> that must be satisfied before the <code>run</code>
rule is executed. If any of the consumed files or variables change, the
rule will be re-executed.</p>
<p>The <code>produces</code> section declares the
<strong>artifacts</strong> that this <code>run</code> rule generates.
Other rules can then declare dependencies on these outputs.</p>
<p>You can include any number of <code>exec</code> or <code>shell</code>
subsections inside a single <code>run</code> rule:</p>
<ul>
<li><code>exec</code> executes a command directly using
<code>execve()</code> (no shell interpretation).</li>
<li><code>shell</code> executes the command via the <code>/bin/sh</code>
shell.</li>
</ul>
<p>Autark also <strong>implicitly tracks dependencies</strong> on the
evaluated arguments passed to <code>exec</code> and <code>shell</code>
commands.</p>
<p>If the special keyword <code>always</code> is present inside the
<code>run</code> rule, the command will be executed
<strong>unconditionally</strong>, regardless of input state. This is
useful, for example, when running test cases or side-effectful
operations.</p>
<div class="sourceCode" id="cb46"><pre
class="sourceCode cfg"><code class="sourceCode ini"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="dt">run {</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="dt">  exec { ${AR} rcs libhello.a ${CC_OBJS} }</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="dt">  consumes {</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="dt">    ${CC_OBJS}</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="dt">  }</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="dt">  produces {</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a><span class="dt">    libhello.a</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="dt">  }</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span></code></pre></div>
<h2 id="in-sources-">in-sources {...}</h2>
<p>By default, most Autark rules are executed inside the
<strong>autark-cache dir</strong> corresponding to the current build
script. This is convenient because generated artifacts, logs, and
temporary files stay in the cache and don't clutter the project source
tree.</p>
<p>However, in some cases, it's necessary to run a command in the
context of the actual project source directory. For this purpose, Autark
provides the <code>in-sources</code> rule.</p>
<div class="sourceCode" id="cb47"><pre
class="sourceCode cfg"><code class="sourceCode ini"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="dt">in-sources {</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="dt">  ...</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span></code></pre></div>
<h3 id="example-appending-glob-matched-source-files">Example: Appending
glob-matched source Files</h3>
<p>In the example below, the <code>SOURCES</code> variable is extended
with the output of a glob-matching command executed in the source
directory. The result is assigned merged with <code>SOURCES</code>
variable in the parent script:</p>
<div class="sourceCode" id="cb48"><pre
class="sourceCode cfg"><code class="sourceCode ini"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="dt">set {</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="dt">  parent {</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="dt">    SOURCES</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="dt">  }</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="dt">  ..${SOURCES}</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="dt">  in-sources {</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="dt">    ..@{autark -C .. glob &#39;json/*.c&#39;}</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="dt">  }</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span></code></pre></div>
<h3 id="example-finding-java-source-files">Example: Finding Java Source
Files</h3>
<div class="sourceCode" id="cb49"><pre
class="sourceCode cfg"><code class="sourceCode ini"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="dt">set {</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="dt">  JAVA_SOURCES</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="dt">  in-sources {</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="dt">    ..@{ find src/main/java -name &#39;*.java&#39; -exec realpath &#39;{}&#39; ; }</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="dt">  }</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span></code></pre></div>
<p>This example populates <code>JAVA_SOURCES</code> with the full paths
of all <code>.java</code> files under <code>src/main/java</code>,
resolved from the script's source directory.</p>
<h2 id="run-on-install-">run-on-install {...}</h2>
<p><code>run-on-install</code> is a special form of the <code>run</code>
rule that is executed during the <code>post-build</code> phase.</p>
<p>A typical use case for this rule is to <strong>install artifacts from
dependent projects</strong> that the current project relies on.</p>
<div class="sourceCode" id="cb50"><pre
class="sourceCode cfg"><code class="sourceCode ini"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="dt">run-on-install {</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="dt">  shell {</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="dt">    autark --prefix ${INSTALL_PREFIX}</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="dt">    set { _</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="dt">      if { ${IWNET_BUILD_SHARED_LIBS}</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="dt">        -DIOWOW_BUILD_SHARED_LIBS</span><span class="ot">=</span><span class="dv">1</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="dt">      }</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a><span class="dt">    }</span></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a><span class="dt">    ${IOWOW_SRC_DIR}</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a><span class="dt">  }</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span></code></pre></div>
<p>In this example, the project invokes Autark to install the dependent
<code>iowow</code> project with the proper build flags and installation
prefix.</p>
<p>Reference: <a
href="https://github.com/Softmotions/iwnet/blob/master/Autark">https://github.com/Softmotions/iwnet/blob/master/Autark</a></p>
<h2 id="foreach-">foreach {...}</h2>
<p>When you need to perform many similar actions for a list of files or
objects, <code>foreach</code> provides a concise and powerful
solution.</p>
<p>Currently, <code>foreach</code> supports only the <code>run</code>
rule as its body.</p>
<div class="sourceCode" id="cb51"><pre
class="sourceCode cfg"><code class="sourceCode ini"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="dt">foreach {</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="dt">  VAR_NAME</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="dt">  LIST_EXPR</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="dt">  run {</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="dt">    ...</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="dt">  }</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span></code></pre></div>
<p><code>foreach</code> iterates over all elements in
<code>LIST_EXPR</code>, and for each element, it sets the variable
<code>VAR_NAME</code> to the current item and evaluates the run
rule.</p>
<hr />
<p>A common use case for <code>foreach</code> is generating and running
per-file executables, such as test cases. Here's an example:</p>
<div class="sourceCode" id="cb52"><pre
class="sourceCode cfg"><code class="sourceCode ini"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="dt">cc {</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="dt">  ${TESTS}</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="dt">  set { _ ${CFLAGS} -I S{} }</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="dt">  ${CC}</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="dt">foreach {</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a><span class="dt">  OBJ</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a><span class="dt">  ${CC_OBJS}</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a><span class="dt">  run {</span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a><span class="dt">    exec { ${CC} ${OBJ} ${LIBAUTARK} -o %{${OBJ}} }</span></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a><span class="dt">    produces {</span></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a><span class="dt">      %{${OBJ}}</span></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a><span class="dt">    }</span></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a><span class="dt">    consumes {</span></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a><span class="dt">      ${LIBAUTARK}</span></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a><span class="dt">      ${OBJ}</span></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a><span class="dt">    }</span></span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a><span class="dt">  }</span></span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Run test cases</span></span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a><span class="dt">if { ${RUN_TESTS}</span></span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a><span class="dt">  foreach {</span></span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a><span class="dt">    OBJ</span></span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a><span class="dt">    ${CC_OBJS}</span></span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a><span class="dt">    run {</span></span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a><span class="dt">      always</span></span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a><span class="dt">      shell { %{${OBJ}} }</span></span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a><span class="dt">      consumes { %{${OBJ}} }</span></span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true" tabindex="-1"></a><span class="dt">    }</span></span>
<span id="cb52-32"><a href="#cb52-32" aria-hidden="true" tabindex="-1"></a><span class="dt">  }</span></span>
<span id="cb52-33"><a href="#cb52-33" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span></code></pre></div>
<p>In this example:</p>
<ul>
<li><code>foreach</code> is used to build a separate binary for each
object file in <code>${CC_OBJS}</code>.</li>
<li>Then, conditionally (<code>if ${RUN_TESTS}</code> is truthy), each
test binary is executed.</li>
<li><code>%{${OBJ}}</code> is used to extract the base name from the
object file path (e.g., <code>main.o =&gt; main</code>).</li>
</ul>
<p>This approach enables clean, scalable test orchestration without
hardcoding individual test names.</p>
<h2 id="cc-----cxx---"><code>cc { ... }</code> /
<code>cxx { ... }</code></h2>
<p>This rule compiles C or C++ source files into object files, while
automatically tracking all required dependencies including header files.
Compilation is parallelized to speed up the build process.</p>
<div class="sourceCode" id="cb53"><pre
class="sourceCode cfg"><code class="sourceCode ini"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="dt">cc|cxx {</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="dt">   SOURCES</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="dt">   </span><span class="kw">[COMPILER_FLAGS]</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="dt">   </span><span class="kw">[COMPILER_CMD]</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="dt">   </span><span class="kw">[objects { NAME }]</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="dt">   </span><span class="kw">[consumes { ... }]</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span></code></pre></div>
<h3 id="sources">SOURCES</h3>
<p>The first argument must be an expression that returns a list of
source files. It can be a single string (for one file) or a list defined
by a <code>set</code> rule.</p>
<p>Paths to source files can be:</p>
<ul>
<li>Absolute paths</li>
<li>Relative to the source directory of the current script</li>
<li>Paths relative to the cache directory corresponding to the script
(this is useful when compiling generated sources from other rules)</li>
</ul>
<h3 id="compiler_flags">COMPILER_FLAGS</h3>
<p>A list of compiler flags, typically defined using a set rule.</p>
<p><strong>Note:</strong> the <code>-I.</code> flag is automatically
added to the compiler flags, which includes the current cache directory
in the include path for header files.</p>
<h3 id="compiler_cmd">COMPILER_CMD</h3>
<p>The compiler to use.</p>
<p>If not explicitly specified:</p>
<ul>
<li>Rule <code>cc</code> uses the <code>CC</code> variable or
<code>cc</code> if variable is not defined.</li>
<li>Rule <code>cxx</code> uses the <code>CXX</code> variable or
<code>c++</code> if variable is not defined.</li>
</ul>
<p><strong>Note:</strong> The compiler must support dependency
generation using the <code>-MMD</code> flag to allow Autark to correctly
track header file dependencies.</p>
<h3 id="objects--name-">objects { NAME }</h3>
<p>By default, the <code>cc</code> rule sets a variable named
<code>CC_OBJS</code> containing the list of object files produced during
compilation.</p>
<p>If you use multiple <code>cc</code> rules within the same build
script, you may want to assign different output variable names using the
<code>objects { NAME }</code> directive.</p>
<p>This allows you to manage multiple sets of object files
independently.</p>
<h3 id="consumes---">consumes { ... }</h3>
<p>This section declares <strong>additional dependencies</strong> for
the <code>cc</code> compilation rule.</p>
<p>For example, if your code depends on a file generated by a
<code>configure</code> rule (such as a generated header file), you must
list it here. This ensures that the <code>configure</code> step is
executed <strong>before</strong> compilation starts.</p>
<hr />
<p>Source files compilation is performed in parallel. By default, the
parallelism level is set to <code>4</code>. You can change this using
the <code>-J</code> option on the command line. For example:</p>
<div class="sourceCode" id="cb54"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="ex">./build.sh</span> <span class="at">-J8</span></span></code></pre></div>
<p>This will run up to 8 compilation jobs in parallel.</p>
<h2 id="library-">library {...}</h2>
<p>Search for a library file by name.</p>
<p>This simple rule looks for the specified <code>LIB_FILES</code>
(e.g., <code>libm.a</code>, <code>libfoo.so</code>) in standard library
locations commonly used across Unix-like systems:</p>
<ul>
<li><code>$HOME/.local/&lt;lib&gt;</code></li>
<li><code>/usr/local/&lt;lib&gt;</code></li>
<li><code>/usr/&lt;lib&gt;</code></li>
<li><code>/&lt;lib&gt;</code></li>
</ul>
<p>Here, <code>&lt;lib&gt;</code> refers to platform-specific
subdirectories where shared or static libraries may be located (such as
<code>lib</code>, <code>lib64</code>, etc., depending on the
system).</p>
<div class="sourceCode" id="cb55"><pre
class="sourceCode cfg"><code class="sourceCode ini"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="dt">library {</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="dt">  | VAR_NAME</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="dt">  | parent { VAR_NAME }</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="dt">  | root { VAR_NAME }</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a><span class="dt">  LIB_FILES...</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span></code></pre></div>
<ul>
<li>The resulting absolute path to the first matched file will be stored
in the specified variable.</li>
<li>You can store it in the current scope (<code>VAR_NAME</code>),
parent script (<code>parent { VAR_NAME }</code>), or root script
(<code>root { VAR_NAME }</code>).</li>
</ul>
<p>Example:</p>
<div class="sourceCode" id="cb56"><pre
class="sourceCode cfg"><code class="sourceCode ini"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="dt">if { library { LIB_M libm.a }</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="dt">  echo { ${LIB_M} }</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="dt">} else {</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="dt">  error { Library libm not found }</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span></code></pre></div>
<p>This will search for <code>libm.a</code>, and if found, store its
absolute path in <code>LIB_M</code> and print it. If the library is not
found, the script will terminate with an error.</p>
<h2 id="install-">install {..}</h2>
<p>If <code>build.sh</code> is run with the <code>-I</code> or
<code>--install</code> option (to install all built artifacts), or if an
install prefix is explicitly specified using <code>-R</code> or
<code>--prefix=&lt;dir&gt;</code>, then all <code>install</code> rules
will be executed after the <code>build</code> phase completes.</p>
<h3 id="available-variables-when-install-is-enabled">Available variables
when install is enabled</h3>
<ul>
<li><code>INSTALL_PREFIX</code> – Absolute path to the installation
prefix. <strong>Default:</strong> <code>$HOME/.local</code></li>
<li><code>INSTALL_BIN_DIR</code> – Path relative to
<code>INSTALL_PREFIX</code> for installing executables.
<strong>Default:</strong> <code>bin</code></li>
<li><code>INSTALL_LIB_DIR</code> – Path relative to
<code>INSTALL_PREFIX</code> for installing libraries.
<strong>Default:</strong> platform-dependent (e.g., <code>lib</code> or
<code>lib64</code>)</li>
<li><code>INSTALL_DATA_DIR</code> – Path relative to
<code>INSTALL_PREFIX</code> for shared data. <strong>Default:</strong>
<code>share</code></li>
<li><code>INSTALL_INCLUDE_DIR</code> – Path relative to
<code>INSTALL_PREFIX</code> for headers. <strong>Default:</strong>
<code>include</code></li>
<li><code>INSTALL_PKGCONFIG_DIR</code> – Path relative to
<code>INSTALL_PREFIX</code> for <code>.pc</code> files.
<strong>Default:</strong> platform-dependent (e.g.,
<code>lib/pkgconfig</code>)</li>
<li><code>INSTALL_MAN_DIR</code> – Path relative to
<code>INSTALL_PREFIX</code> for man pages. <strong>Default:</strong>
<code>share/man</code></li>
</ul>
<div class="sourceCode" id="cb57"><pre
class="sourceCode cfg"><code class="sourceCode ini"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="dt">install { INSTAL_DIR_EXPR FILES... }</span></span></code></pre></div>
<p>The install rule copies the specified files into the target directory
<code>${INSTALL_PREFIX}/${INSTALL_DIR_EXPR}</code> (creating it if
necessary). File permissions from the original files are preserved
during the copy.</p>
<p>Example:</p>
<div class="sourceCode" id="cb58"><pre
class="sourceCode cfg"><code class="sourceCode ini"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="dt">install { ${INSTALL_PKGCONFIG_DIR} libiwnet.pc }</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="dt">install { ${INSTALL_INCLUDE_DIR} ${PUB_HDRS} }</span></span></code></pre></div>
<p>This will install <code>libiwnet.pc</code> into the appropriate
pkgconfig directory, and public headers into the include directory under
the chosen prefix.</p>
<h1 id="license">License</h1>
<pre><code>
MIT License

Copyright (c) 2012-2025 Softmotions Ltd &lt;info@softmotions.com&gt;

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the &quot;Software&quot;), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
</code></pre>
</body>
</html>
